<?php

require_once('../lib.php');


/*$ItemID = 63777;
$ItemID = 78260;
$ItemID = 63491;
$ItemID = 63426;

$ItemID = 79452;*/

$Items = array(84547);

// BMNH Zool
$Items = array(84546,88480,84548,84549,85288,85291,85292,85287);

// Proceedings of the Zoological Society of London
$Items=array(97650);
$Items=array(92048, 92484, 93424, 96158, 96163, 96165, 96442, 96443, 96445, 96679, 96698, 96831, 96832, 96834, 96836, 96871, 96894, 97094, 97095, 97151, 97156, 97157, 97158, 97165, 97224, 97225, 97256, 97409, 97658, 97660, 97667, 97668, 97669, 97670, 97671, 97672, 97764, 97765, 97766, 98459, 98466, 98471, 98473, 98474, 98477, 98493, 98497, 98501, 98503, 98513, 98517, 98524, 98525, 98527, 98528, 98530, 98531, 98540, 98562, 98584, 98587, 98617, 98658, 99080, 99199, 99299, 99351, 99375, 99377, 99378, 99485, 99486, 99487, 99488, 99643, 99645, 99805, 99850);

$Items=array(95638,
93111,
93398,
93403,
95509,
93385,
93412);

$Items=array(94955);

$Items=array(94923);

// Annals of tropical medicine and parasitology
$Items=array(98765,
96750,
96751,
96752,
96604,
96753);

// Proceedings of the Zoological Society of London (extra)
$Items=array(100045,
100198,
100585,
100589,
100598,
100613,
100996);

// BHL fuck ups
// Proceedings of the Zoological Society of Londo

$Items=array(46225);
$Items=array(46212);

// Univ Kansas Bull
$Items=array(91701);

// Journal de conchyliologie.
$Items=array(81370);

// Proc Calif 4th series extra
$Items=array(84615,
85194,
85250);

// 3rd series extra
$Items=array(98467);

$Items=array(98465);

// Proc U S N M
$Items=array(88912,
94484,
99942);

// Proc Ent Soc Wash
$Items=array(54606,54651,54652,54654,54655,54663,54666,54667,54668,54669,54672,54695,54696,54697,54698,54709,54710,54711,54712,54765,54767,54775,54777,54778,54792,54793,54810,54811,54812,54813,54814,54815,54854,54855,54859,54866,54899,54937,54938,54955,54962,54979,54980,54981,54986,55015,55017,55043,55068,55083,55154,55199,55205,55207,55215,55252,81132,81133,81298,84616,84617,84949,89742,95279,95531,97365);

// Proc Ent Soc Wash
$Items=array(100258);

// Ent News
$Items=array(79668);

$Items=array(59708);

// Novon
$Items=array(55396,90519,92595);
$Items=array(55381);

// ann mag
$Items=array(94944);

// Trans Linn Soc TitleID=8257
$Items=array(55279,
55291,
55323,
55329,
55334,
55337,
81420,
81421,
86004,
90111);


$Items=array(102952);

$Items=array(88934); //TvE

// J Lin  Soc Lond Zool
$Items=array(98595,
99085,
98556,
100042,
99813,
98585,
99383,
99814,
98664,
98724,
99211,
98725,
98559,
98582,
98716,
99851,
99469,
98709,
99466,
98586,
98506,
98662,
100259,
98583,
99101,
98560);

// Bull Mus Comp Zool
$Items=array(54619,54620,85041,87759,91578,91579,91580,91581,91592,91593,91594,91600,91607,91608,91609,91610,91652,91653,91654,91655,91656,91657,91658,91659,91660,93764,95201,95202,95203,95211,95212,95213,95214,95215,95216,95217,95218,95357,95369,95375,95436,95437,95438,95439,95440,95443,95444,95611,95612,95613,95622,95623,95624,95816,95817,95818,95819,95862,96039,96065,96066,96181,96182,96183,96674,97351,98449,98450,98451,98596);


$Items=array(100961);

$Items=array(100492,100493,100494,100495,100496,100497,100510,100511,100513,100514,100515,100518,100535,100541,100619,100621,100623,100624,100637,100638,100641,100642,100643,100696,100706,100715,100834,100835,100843,100845,100846,100847,100848,100850,100854,100992,100993,54169,54170,54172,54173,54175,54178,54201,54203,54205,79307);

$Items=array(107266,106571,107267,106286,106278,105973,105970,106479,106994,106579);

$Items=array(84659,
84660,
54689,
54642,
54686,
54671,
84661,
54680,
54670,
54633,
54682,
84662);

// Proc Biol Soc Wash
$Items=array(107376,107498,107508,107491,107492,107512,107495,107515,107539,107520,107497,107375,107374,107522,107524,107336,107526,107489,107533,107518,107490,107535,107519,107513,107514,107516,107510,107501,107509,107500,107532,107493,107537,107534,107511,107523);

// Proc Biol Soc Wash...
$Items=array(107567,107570,107571,107575,107577,107580,107581,107585,107588,107589,107593,107599,107600,107601,107602,107603,107604);


$Items=array(107614,
107615,
107611,
107610,
107613,
107608,
107607,
107609,
107616
);

$Items=array(101148,10131,101324,101326,101476,101668,101669,101671,103040,106705,79312,79355,79414,84710,84714,84716,84720,84721,84728,84748,84752,84764,84868,84869,84877,84882,84888,84901,92465,95704);

// Fix pagination in P US N Mus
$Items=array(53494);

$Items=array(53945,95242,95250,95301,95302,95307,95309,95311,95328,95330,95456,95460,95532,95721,95740,95824,95912,96941);

$Items=array(54218,91122,91265,91267,91387,91389,91390,91469,91777,91779,96833,96838,96844,96845,96852,96889,96891,97233,97378,97410,98701,98703,98704,98734,98752,100332,100487,101600,101603,105237);

$Items=array(93353,93362,93358,92812,93351,92716,93361,94832,93020,93021,92664,92714,93070,93354,93365,93033,92721,92833,93360,93352,92835,93363,93426,94825,93024,93029,92834,92718,93035,94926,93367,93030,93022,93034,93053,93051,93031,93785,93356,94824,92836,92663,92705,92723,93364,93355,92831,93357,93359,93369,92832,92725,92697,93368,94831,92711,92536,92717,93032,92720);

$Items=array(81642);

$Items=array(100097,100130,100631,100961,100979,101158,101212,101224,101225,101293,101294,101295,101296,101297,101298,101299,101300,101301,101302,101303,101304,101305,105193,105205,105316,105669,105670,105673,105675,105676,105799,105831,106155,106189,106291,106560,106568,107112,52380,53389,81620,81623,81625,81626,95530,96026,96847,96848,96849);

$Items=array(94502);

$Items=array(103044,
103048,
103049
);

$Items=array(106493,
106496,
106546,
106593,
106649,
106682);

// Proc Linn Soc
$Items=array(108439,108440,108531,108532,108533,108534,108560,108561,108562,108590,108591,108592,108593,108603,108604,108605,108606,108607,108608,108609,108623,108624,108625,108626,108627,108628,108629,108630,108631,108641,108642,108643,108644,108645,108646,108647,108648,108649,108650,108660,108661,108662,108663,108664,108665,108666,108667,108668,108669,108670,108671,108672,108673,108674,108675,108707,108708,108709,80769,82331,82332);

$Items=array(
100626,
105795,
107646,
94425,
94436,
94437,
94438,
94472,
94497,
94498,
94500,
94501,
94502,
94504,
94506,
95074,
95179,
95241,
95300,
95545
);

$Items=array(
105188,
105790,
106287,
53699,
53816,
53817,
53891,
53894
);

$Items=array(108773);

$Items=array(25311);
$Items=array(26726);

$Items=array(54212,
54291,
54415,
55159,
55160,
84615,
85194,
85250,
85251,
97652,
98465,
98588,
98660,
99189,
103002);

$Items=array(54212, 103002,53858,53860);

// Lep Index
$Items=array(103554,
103300,
103327,
103628,
103496,
103503,
103631,
104151,
103505,
103495);

$Items=array(
107266,
107267,
107308,
107517,
107738,
108012,
108335,
109473
);

$Items=array(
106577,
106911
);

$Items=array(
100091,
97574,
97575,
98666,
98680,
98688,
98692,
98693,
98694,
98732,
98733,
99471,
99509,
99510,
99522,
99523,
99524,
99525,
99526,
99550,
99675,
99676,
99677,
99769,
99770,
99771,
99772,
99774,
99776,
99777,
99778
);

$Items=array(
84622,
54645,
84623,
54634,
85044,
84624,
84618,
54637,
84619,
84620,
54617,
54688,
84621
);

$Items = array(
100615,
100665,
100666,
100667,
100668,
100697,
100698,
100699,
100700,
100708,
100710,
100711,
100712,
100713,
100720,
100725,
100726,
100727,
100728,
100729,
100731,
100735,
100852,
100853,
106380,
106413,
36912,
36922,
37544,
42037,
42609,
42690,
42691,
42692,
42693
);

foreach ($Items as $ItemID)
{
	// Fetch $html 
	
	$html = get('http://www.biodiversitylibrary.org/item/' . $ItemID);
	
	$Title = 0;
	$VolumeInfo = '';
	$sql = '';
	
	$done_pages = false;
	
	$lines = explode("\n", $html);
	
	// PageID for this item...
	$SequenceOrder = 1;
	foreach ($lines as $line)
	{
		if (preg_match('/<option selected="selected" value="' . $ItemID . '">(?<VolumeInfo>.*)<\/option>/', $line, $matches))
		{
			$VolumeInfo = $matches['VolumeInfo'];
		}
	
		if (preg_match('/<a href="\/bibliography\/(?<TitleID>\d+)"/', $line, $matches))
		{
			$TitleID = $matches['TitleID'];
		}

		if (preg_match('/<td class="volume"/', $line, $matches))
		{
			$done_pages = true;
		}
		
		if (!$done_pages)
		{
			if (preg_match('/<option(\s+selected="selected")?\s+value="(?<PageID>\d+)">(Page (?<PageNumber>\d+)|(?<PageTypeName>.*))<\/option>/', $line, $matches))
			{
				//print_r($matches);
				
				$keys = array();
				$values = array();
				
				// PageID
				$keys[] = 'PageID';
				$values[] = $matches['PageID'];
				
				// ItemID
				$keys[] = 'ItemID';
				$values[] = $ItemID;
		
				// Is page numbered
				if ($matches['PageNumber'] != '')
				{
					$keys[] = 'PagePrefix';
					$values[] = '"Page"';
		
					$keys[] = 'PageNumber';
					$values[] = '"' . $matches['PageNumber'] . '"';
					
					if (isset($matches['PageTypeName']))
					{
						if ($matches['PageTypeName'] == '')
						{
							$keys[] = 'PageTypeName';
							$values[] = '"Text"';				
						}
					}
				}
		
				if (isset($matches['PageTypeName']))
				{
					if ($matches['PageTypeName'] != '')
					{
						$keys[] = 'PageTypeName';
						$values[] = '"' . $matches['PageTypeName'] . '"';			
					}
				}
				
				// fix
				$sql .= 'DELETE FROM bhl_page WHERE PageID=' . $matches['PageID'] . ';' . "\n";
				$sql .= 'INSERT INTO bhl_page (' . implode (",", $keys) . ') VALUES (' . implode (",", $values) . ');' . "\n";
				
				// fix
				$sql .= 'DELETE FROM page WHERE PageID=' . $matches['PageID'] . ';' . "\n";
				$sql .= 'INSERT INTO page (PageID,ItemID,FileNamePrefix,SequenceOrder) VALUES('
				. $matches['PageID']
				. ',' . $ItemID
				. ',' . $matches['PageID'] // Fake this as we need FileNamePrefix to name images in cache
				. ',' . $SequenceOrder++
				.');' . "\n";
			}
		}
	}
	
	// Avoid duplicates
	$sql .= 'DELETE FROM bhl_item WHERE ItemID=' . $ItemID . ';' . "\n";
	
	$sql .= "INSERT INTO bhl_item(ItemID,TitleID,VolumeInfo) VALUES("
	. $ItemID . ',' . $TitleID . ', "' . $VolumeInfo . '");'  . "\n";
	
	$filename = $ItemID . '.sql';
	$file = @fopen($filename, "w") or die("couldn't open file \"$filename\"");
	fwrite($file, $sql);
	fclose($file);
	
}


?>
